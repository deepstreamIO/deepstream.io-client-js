/*! deepstream.io-client-js 2.1.1 (c)2016 deepstreamHub GmbH, with parts (c)2016 Joyent and contributers  @licence Apache-2.0*/
!function(a){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=a();else if("function"==typeof define&&define.amd)define([],a);else{var b;b="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this,b.deepstream=a()}}(function(){var a;return function a(b,c,d){function e(g,h){if(!c[g]){if(!b[g]){var i="function"==typeof require&&require;if(!h&&i)return i(g,!0);if(f)return f(g,!0);var j=new Error("Cannot find module '"+g+"'");throw j.code="MODULE_NOT_FOUND",j}var k=c[g]={exports:{}};b[g][0].call(k.exports,function(a){var c=b[g][1][a];return e(c?c:a)},k,k.exports,a,b,c,d)}return c[g].exports}for(var f="function"==typeof require&&require,g=0;g<d.length;g++)e(d[g]);return e}({1:[function(a,b,c){},{}],2:[function(a,b,c){function d(a){if(a)return e(a)}function e(a){for(var b in d.prototype)a[b]=d.prototype[b];return a}b.exports=d,d.prototype.on=d.prototype.addEventListener=function(a,b){return this._callbacks=this._callbacks||{},(this._callbacks[a]=this._callbacks[a]||[]).push(b),this},d.prototype.once=function(a,b){function c(){d.off(a,c),b.apply(this,arguments)}var d=this;return this._callbacks=this._callbacks||{},c.fn=b,this.on(a,c),this},d.prototype.off=d.prototype.removeListener=d.prototype.removeAllListeners=d.prototype.removeEventListener=function(a,b){if(this._callbacks=this._callbacks||{},0==arguments.length)return this._callbacks={},this;var c=this._callbacks[a];if(!c)return this;if(1==arguments.length)return delete this._callbacks[a],this;for(var d,e=0;e<c.length;e++)if(d=c[e],d===b||d.fn===b){c.splice(e,1);break}return this},d.prototype.emit=function(a){this._callbacks=this._callbacks||{};var b=[].slice.call(arguments,1),c=this._callbacks[a];if(c){c=c.slice(0);for(var d=0,e=c.length;d<e;++d)c[d].apply(this,b)}return this},d.prototype.listeners=function(a){return this._callbacks=this._callbacks||{},this._callbacks[a]||[]},d.prototype.hasListeners=function(a){return!!this.listeners(a).length}},{}],3:[function(a,b,c){function d(){throw new Error("setTimeout has not been defined")}function e(){throw new Error("clearTimeout has not been defined")}function f(a){if(l===setTimeout)return setTimeout(a,0);if((l===d||!l)&&setTimeout)return l=setTimeout,setTimeout(a,0);try{return l(a,0)}catch(b){try{return l.call(null,a,0)}catch(b){return l.call(this,a,0)}}}function g(a){if(m===clearTimeout)return clearTimeout(a);if((m===e||!m)&&clearTimeout)return m=clearTimeout,clearTimeout(a);try{return m(a)}catch(b){try{return m.call(null,a)}catch(b){return m.call(this,a)}}}function h(){q&&o&&(q=!1,o.length?p=o.concat(p):r=-1,p.length&&i())}function i(){if(!q){var a=f(h);q=!0;for(var b=p.length;b;){for(o=p,p=[];++r<b;)o&&o[r].run();r=-1,b=p.length}o=null,q=!1,g(a)}}function j(a,b){this.fun=a,this.array=b}function k(){}var l,m,n=b.exports={};!function(){try{l="function"==typeof setTimeout?setTimeout:d}catch(a){l=d}try{m="function"==typeof clearTimeout?clearTimeout:e}catch(a){m=e}}();var o,p=[],q=!1,r=-1;n.nextTick=function(a){var b=new Array(arguments.length-1);if(arguments.length>1)for(var c=1;c<arguments.length;c++)b[c-1]=arguments[c];p.push(new j(a,b)),1!==p.length||q||f(i)},j.prototype.run=function(){this.fun.apply(null,this.array)},n.title="browser",n.browser=!0,n.env={},n.argv=[],n.version="",n.versions={},n.on=k,n.addListener=k,n.once=k,n.off=k,n.removeListener=k,n.removeAllListeners=k,n.emit=k,n.binding=function(a){throw new Error("process.binding is not supported")},n.cwd=function(){return"/"},n.chdir=function(a){throw new Error("process.chdir is not supported")},n.umask=function(){return 0}},{}],4:[function(b,c,d){(function(b){!function(e){function f(a){throw new RangeError(I[a])}function g(a,b){for(var c=a.length,d=[];c--;)d[c]=b(a[c]);return d}function h(a,b){var c=a.split("@"),d="";c.length>1&&(d=c[0]+"@",a=c[1]),a=a.replace(H,".");var e=a.split("."),f=g(e,b).join(".");return d+f}function i(a){for(var b,c,d=[],e=0,f=a.length;e<f;)b=a.charCodeAt(e++),b>=55296&&b<=56319&&e<f?(c=a.charCodeAt(e++),56320==(64512&c)?d.push(((1023&b)<<10)+(1023&c)+65536):(d.push(b),e--)):d.push(b);return d}function j(a){return g(a,function(a){var b="";return a>65535&&(a-=65536,b+=L(a>>>10&1023|55296),a=56320|1023&a),b+=L(a)}).join("")}function k(a){return a-48<10?a-22:a-65<26?a-65:a-97<26?a-97:x}function l(a,b){return a+22+75*(a<26)-((0!=b)<<5)}function m(a,b,c){var d=0;for(a=c?K(a/B):a>>1,a+=K(a/b);a>J*z>>1;d+=x)a=K(a/J);return K(d+(J+1)*a/(a+A))}function n(a){var b,c,d,e,g,h,i,l,n,o,p=[],q=a.length,r=0,s=D,t=C;for(c=a.lastIndexOf(E),c<0&&(c=0),d=0;d<c;++d)a.charCodeAt(d)>=128&&f("not-basic"),p.push(a.charCodeAt(d));for(e=c>0?c+1:0;e<q;){for(g=r,h=1,i=x;e>=q&&f("invalid-input"),l=k(a.charCodeAt(e++)),(l>=x||l>K((w-r)/h))&&f("overflow"),r+=l*h,n=i<=t?y:i>=t+z?z:i-t,!(l<n);i+=x)o=x-n,h>K(w/o)&&f("overflow"),h*=o;b=p.length+1,t=m(r-g,b,0==g),K(r/b)>w-s&&f("overflow"),s+=K(r/b),r%=b,p.splice(r++,0,s)}return j(p)}function o(a){var b,c,d,e,g,h,j,k,n,o,p,q,r,s,t,u=[];for(a=i(a),q=a.length,b=D,c=0,g=C,h=0;h<q;++h)p=a[h],p<128&&u.push(L(p));for(d=e=u.length,e&&u.push(E);d<q;){for(j=w,h=0;h<q;++h)p=a[h],p>=b&&p<j&&(j=p);for(r=d+1,j-b>K((w-c)/r)&&f("overflow"),c+=(j-b)*r,b=j,h=0;h<q;++h)if(p=a[h],p<b&&++c>w&&f("overflow"),p==b){for(k=c,n=x;o=n<=g?y:n>=g+z?z:n-g,!(k<o);n+=x)t=k-o,s=x-o,u.push(L(l(o+t%s,0))),k=K(t/s);u.push(L(l(k,0))),g=m(c,r,d==e),c=0,++d}++c,++b}return u.join("")}function p(a){return h(a,function(a){return F.test(a)?n(a.slice(4).toLowerCase()):a})}function q(a){return h(a,function(a){return G.test(a)?"xn--"+o(a):a})}var r="object"==typeof d&&d&&!d.nodeType&&d,s="object"==typeof c&&c&&!c.nodeType&&c,t="object"==typeof b&&b;t.global!==t&&t.window!==t&&t.self!==t||(e=t);var u,v,w=2147483647,x=36,y=1,z=26,A=38,B=700,C=72,D=128,E="-",F=/^xn--/,G=/[^\x20-\x7E]/,H=/[\x2E\u3002\uFF0E\uFF61]/g,I={overflow:"Overflow: input needs wider integers to process","not-basic":"Illegal input >= 0x80 (not a basic code point)","invalid-input":"Invalid input"},J=x-y,K=Math.floor,L=String.fromCharCode;if(u={version:"1.4.1",ucs2:{decode:i,encode:j},decode:n,encode:o,toASCII:q,toUnicode:p},"function"==typeof a&&"object"==typeof a.amd&&a.amd)a("punycode",function(){return u});else if(r&&s)if(c.exports==r)s.exports=u;else for(v in u)u.hasOwnProperty(v)&&(r[v]=u[v]);else e.punycode=u}(this)}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],5:[function(a,b,c){"use strict";function d(a,b){return Object.prototype.hasOwnProperty.call(a,b)}b.exports=function(a,b,c,f){b=b||"&",c=c||"=";var g={};if("string"!=typeof a||0===a.length)return g;var h=/\+/g;a=a.split(b);var i=1e3;f&&"number"==typeof f.maxKeys&&(i=f.maxKeys);var j=a.length;i>0&&j>i&&(j=i);for(var k=0;k<j;++k){var l,m,n,o,p=a[k].replace(h,"%20"),q=p.indexOf(c);q>=0?(l=p.substr(0,q),m=p.substr(q+1)):(l=p,m=""),n=decodeURIComponent(l),o=decodeURIComponent(m),d(g,n)?e(g[n])?g[n].push(o):g[n]=[g[n],o]:g[n]=o}return g};var e=Array.isArray||function(a){return"[object Array]"===Object.prototype.toString.call(a)}},{}],6:[function(a,b,c){"use strict";function d(a,b){if(a.map)return a.map(b);for(var c=[],d=0;d<a.length;d++)c.push(b(a[d],d));return c}var e=function(a){switch(typeof a){case"string":return a;case"boolean":return a?"true":"false";case"number":return isFinite(a)?a:"";default:return""}};b.exports=function(a,b,c,h){return b=b||"&",c=c||"=",null===a&&(a=void 0),"object"==typeof a?d(g(a),function(g){var h=encodeURIComponent(e(g))+c;return f(a[g])?d(a[g],function(a){return h+encodeURIComponent(e(a))}).join(b):h+encodeURIComponent(e(a[g]))}).join(b):h?encodeURIComponent(e(h))+c+encodeURIComponent(e(a)):""};var f=Array.isArray||function(a){return"[object Array]"===Object.prototype.toString.call(a)},g=Object.keys||function(a){var b=[];for(var c in a)Object.prototype.hasOwnProperty.call(a,c)&&b.push(c);return b}},{}],7:[function(a,b,c){"use strict";c.decode=c.parse=a("./decode"),c.encode=c.stringify=a("./encode")},{"./decode":5,"./encode":6}],8:[function(a,b,c){"use strict";function d(){this.protocol=null,this.slashes=null,this.auth=null,this.host=null,this.port=null,this.hostname=null,this.hash=null,this.search=null,this.query=null,this.pathname=null,this.path=null,this.href=null}function e(a,b,c){if(a&&j.isObject(a)&&a instanceof d)return a;var e=new d;return e.parse(a,b,c),e}function f(a){return j.isString(a)&&(a=e(a)),a instanceof d?a.format():d.prototype.format.call(a)}function g(a,b){return e(a,!1,!0).resolve(b)}function h(a,b){return a?e(a,!1,!0).resolveObject(b):b}var i=a("punycode"),j=a("./util");c.parse=e,c.resolve=g,c.resolveObject=h,c.format=f,c.Url=d;var k=/^([a-z0-9.+-]+:)/i,l=/:[0-9]*$/,m=/^(\/\/?(?!\/)[^\?\s]*)(\?[^\s]*)?$/,n=["<",">",'"',"`"," ","\r","\n","\t"],o=["{","}","|","\\","^","`"].concat(n),p=["'"].concat(o),q=["%","/","?",";","#"].concat(p),r=["/","?","#"],s=255,t=/^[+a-z0-9A-Z_-]{0,63}$/,u=/^([+a-z0-9A-Z_-]{0,63})(.*)$/,v={javascript:!0,"javascript:":!0},w={javascript:!0,"javascript:":!0},x={http:!0,https:!0,ftp:!0,gopher:!0,file:!0,"http:":!0,"https:":!0,"ftp:":!0,"gopher:":!0,"file:":!0},y=a("querystring");d.prototype.parse=function(a,b,c){if(!j.isString(a))throw new TypeError("Parameter 'url' must be a string, not "+typeof a);var d=a.indexOf("?"),e=d!==-1&&d<a.indexOf("#")?"?":"#",f=a.split(e),g=/\\/g;f[0]=f[0].replace(g,"/"),a=f.join(e);var h=a;if(h=h.trim(),!c&&1===a.split("#").length){var l=m.exec(h);if(l)return this.path=h,this.href=h,this.pathname=l[1],l[2]?(this.search=l[2],b?this.query=y.parse(this.search.substr(1)):this.query=this.search.substr(1)):b&&(this.search="",this.query={}),this}var n=k.exec(h);if(n){n=n[0];var o=n.toLowerCase();this.protocol=o,h=h.substr(n.length)}if(c||n||h.match(/^\/\/[^@\/]+@[^@\/]+/)){var z="//"===h.substr(0,2);!z||n&&w[n]||(h=h.substr(2),this.slashes=!0)}if(!w[n]&&(z||n&&!x[n])){for(var A=-1,B=0;B<r.length;B++){var C=h.indexOf(r[B]);C!==-1&&(A===-1||C<A)&&(A=C)}var D,E;E=A===-1?h.lastIndexOf("@"):h.lastIndexOf("@",A),E!==-1&&(D=h.slice(0,E),h=h.slice(E+1),this.auth=decodeURIComponent(D)),A=-1;for(var B=0;B<q.length;B++){var C=h.indexOf(q[B]);C!==-1&&(A===-1||C<A)&&(A=C)}A===-1&&(A=h.length),this.host=h.slice(0,A),h=h.slice(A),this.parseHost(),this.hostname=this.hostname||"";var F="["===this.hostname[0]&&"]"===this.hostname[this.hostname.length-1];if(!F)for(var G=this.hostname.split(/\./),B=0,H=G.length;B<H;B++){var I=G[B];if(I&&!I.match(t)){for(var J="",K=0,L=I.length;K<L;K++)J+=I.charCodeAt(K)>127?"x":I[K];if(!J.match(t)){var M=G.slice(0,B),N=G.slice(B+1),O=I.match(u);O&&(M.push(O[1]),N.unshift(O[2])),N.length&&(h="/"+N.join(".")+h),this.hostname=M.join(".");break}}}this.hostname.length>s?this.hostname="":this.hostname=this.hostname.toLowerCase(),F||(this.hostname=i.toASCII(this.hostname));var P=this.port?":"+this.port:"",Q=this.hostname||"";this.host=Q+P,this.href+=this.host,F&&(this.hostname=this.hostname.substr(1,this.hostname.length-2),"/"!==h[0]&&(h="/"+h))}if(!v[o])for(var B=0,H=p.length;B<H;B++){var R=p[B];if(h.indexOf(R)!==-1){var S=encodeURIComponent(R);S===R&&(S=escape(R)),h=h.split(R).join(S)}}var T=h.indexOf("#");T!==-1&&(this.hash=h.substr(T),h=h.slice(0,T));var U=h.indexOf("?");if(U!==-1?(this.search=h.substr(U),this.query=h.substr(U+1),b&&(this.query=y.parse(this.query)),h=h.slice(0,U)):b&&(this.search="",this.query={}),h&&(this.pathname=h),x[o]&&this.hostname&&!this.pathname&&(this.pathname="/"),this.pathname||this.search){var P=this.pathname||"",V=this.search||"";this.path=P+V}return this.href=this.format(),this},d.prototype.format=function(){var a=this.auth||"";a&&(a=encodeURIComponent(a),a=a.replace(/%3A/i,":"),a+="@");var b=this.protocol||"",c=this.pathname||"",d=this.hash||"",e=!1,f="";this.host?e=a+this.host:this.hostname&&(e=a+(this.hostname.indexOf(":")===-1?this.hostname:"["+this.hostname+"]"),this.port&&(e+=":"+this.port)),this.query&&j.isObject(this.query)&&Object.keys(this.query).length&&(f=y.stringify(this.query));var g=this.search||f&&"?"+f||"";return b&&":"!==b.substr(-1)&&(b+=":"),this.slashes||(!b||x[b])&&e!==!1?(e="//"+(e||""),c&&"/"!==c.charAt(0)&&(c="/"+c)):e||(e=""),d&&"#"!==d.charAt(0)&&(d="#"+d),g&&"?"!==g.charAt(0)&&(g="?"+g),c=c.replace(/[?#]/g,function(a){return encodeURIComponent(a)}),g=g.replace("#","%23"),b+e+c+g+d},d.prototype.resolve=function(a){return this.resolveObject(e(a,!1,!0)).format()},d.prototype.resolveObject=function(a){if(j.isString(a)){var b=new d;b.parse(a,!1,!0),a=b}for(var c=new d,e=Object.keys(this),f=0;f<e.length;f++){var g=e[f];c[g]=this[g]}if(c.hash=a.hash,""===a.href)return c.href=c.format(),c;if(a.slashes&&!a.protocol){for(var h=Object.keys(a),i=0;i<h.length;i++){var k=h[i];"protocol"!==k&&(c[k]=a[k])}return x[c.protocol]&&c.hostname&&!c.pathname&&(c.path=c.pathname="/"),c.href=c.format(),c}if(a.protocol&&a.protocol!==c.protocol){if(!x[a.protocol]){for(var l=Object.keys(a),m=0;m<l.length;m++){var n=l[m];c[n]=a[n]}return c.href=c.format(),c}if(c.protocol=a.protocol,a.host||w[a.protocol])c.pathname=a.pathname;else{for(var o=(a.pathname||"").split("/");o.length&&!(a.host=o.shift()););a.host||(a.host=""),a.hostname||(a.hostname=""),""!==o[0]&&o.unshift(""),o.length<2&&o.unshift(""),c.pathname=o.join("/")}if(c.search=a.search,c.query=a.query,c.host=a.host||"",c.auth=a.auth,c.hostname=a.hostname||a.host,c.port=a.port,c.pathname||c.search){var p=c.pathname||"",q=c.search||"";c.path=p+q}return c.slashes=c.slashes||a.slashes,c.href=c.format(),c}var r=c.pathname&&"/"===c.pathname.charAt(0),s=a.host||a.pathname&&"/"===a.pathname.charAt(0),t=s||r||c.host&&a.pathname,u=t,v=c.pathname&&c.pathname.split("/")||[],o=a.pathname&&a.pathname.split("/")||[],y=c.protocol&&!x[c.protocol];if(y&&(c.hostname="",c.port=null,c.host&&(""===v[0]?v[0]=c.host:v.unshift(c.host)),c.host="",a.protocol&&(a.hostname=null,a.port=null,a.host&&(""===o[0]?o[0]=a.host:o.unshift(a.host)),a.host=null),t=t&&(""===o[0]||""===v[0])),s)c.host=a.host||""===a.host?a.host:c.host,c.hostname=a.hostname||""===a.hostname?a.hostname:c.hostname,c.search=a.search,c.query=a.query,v=o;else if(o.length)v||(v=[]),v.pop(),v=v.concat(o),c.search=a.search,c.query=a.query;else if(!j.isNullOrUndefined(a.search)){if(y){c.hostname=c.host=v.shift();var z=!!(c.host&&c.host.indexOf("@")>0)&&c.host.split("@");z&&(c.auth=z.shift(),c.host=c.hostname=z.shift())}return c.search=a.search,c.query=a.query,j.isNull(c.pathname)&&j.isNull(c.search)||(c.path=(c.pathname?c.pathname:"")+(c.search?c.search:"")),c.href=c.format(),c}if(!v.length)return c.pathname=null,c.search?c.path="/"+c.search:c.path=null,c.href=c.format(),c;for(var A=v.slice(-1)[0],B=(c.host||a.host||v.length>1)&&("."===A||".."===A)||""===A,C=0,D=v.length;D>=0;D--)A=v[D],"."===A?v.splice(D,1):".."===A?(v.splice(D,1),C++):C&&(v.splice(D,1),C--);if(!t&&!u)for(;C--;C)v.unshift("..");!t||""===v[0]||v[0]&&"/"===v[0].charAt(0)||v.unshift(""),B&&"/"!==v.join("/").substr(-1)&&v.push("");var E=""===v[0]||v[0]&&"/"===v[0].charAt(0);if(y){c.hostname=c.host=E?"":v.length?v.shift():"";var z=!!(c.host&&c.host.indexOf("@")>0)&&c.host.split("@");z&&(c.auth=z.shift(),c.host=c.hostname=z.shift())}return t=t||c.host&&v.length,t&&!E&&v.unshift(""),v.length?c.pathname=v.join("/"):(c.pathname=null,c.path=null),j.isNull(c.pathname)&&j.isNull(c.search)||(c.path=(c.pathname?c.pathname:"")+(c.search?c.search:"")),c.auth=a.auth||c.auth,c.slashes=c.slashes||a.slashes,c.href=c.format(),c},d.prototype.parseHost=function(){var a=this.host,b=l.exec(a);b&&(b=b[0],":"!==b&&(this.port=b.substr(1)),a=a.substr(0,a.length-b.length)),a&&(this.hostname=a)}},{"./util":9,punycode:4,querystring:7}],9:[function(a,b,c){"use strict";b.exports={isString:function(a){return"string"==typeof a},isObject:function(a){return"object"==typeof a&&null!==a},isNull:function(a){return null===a},isNullOrUndefined:function(a){return null==a}}},{}],10:[function(a,b,c){function d(a,b){return new n(a,b)}var e=a("./constants/constants"),f=a("./constants/merge-strategies"),g=a("component-emitter"),h=a("./message/connection"),i=a("./event/event-handler"),j=a("./rpc/rpc-handler"),k=a("./record/record-handler"),l=a("./presence/presence-handler"),m=a("./default-options"),n=(a("./message/message-builder"),function(a,b){this._url=a,this._options=this._getOptions(b||{}),this._connection=new h(this,this._url,this._options),this.event=new i(this._options,this._connection,this),this.rpc=new j(this._options,this._connection,this),this.record=new k(this._options,this._connection,this),this.presence=new l(this._options,this._connection,this),this._messageCallbacks={},this._messageCallbacks[e.TOPIC.EVENT]=this.event._$handle.bind(this.event),this._messageCallbacks[e.TOPIC.RPC]=this.rpc._$handle.bind(this.rpc),this._messageCallbacks[e.TOPIC.RECORD]=this.record._$handle.bind(this.record),this._messageCallbacks[e.TOPIC.PRESENCE]=this.presence._$handle.bind(this.presence),this._messageCallbacks[e.TOPIC.ERROR]=this._onErrorMessage.bind(this)});g(n.prototype),n.prototype.login=function(a,b){return this._connection.authenticate(a||{},b),this},n.prototype.close=function(){this._connection.close()},n.prototype.getConnectionState=function(){return this._connection.getState()},n.prototype.getUid=function(){var a=(new Date).getTime().toString(36),b=(1e16*Math.random()).toString(36).replace(".","");return a+"-"+b},n.prototype._$onMessage=function(a){this._messageCallbacks[a.topic]?this._messageCallbacks[a.topic](a):(a.processedError=!0,this._$onError(a.topic,e.EVENT.MESSAGE_PARSE_ERROR,"Received message for unknown topic "+a.topic)),a.action!==e.ACTIONS.ERROR||a.processedError||this._$onError(a.topic,a.data[0],a.data.slice(0))},n.prototype._$onError=function(a,b,c){var d;if(b!==e.EVENT.ACK_TIMEOUT&&b!==e.EVENT.RESPONSE_TIMEOUT||this.getConnectionState()===e.CONNECTION_STATE.AWAITING_AUTHENTICATION&&(d="Your message timed out because you're not authenticated. Have you called login()?",setTimeout(this._$onError.bind(this,e.EVENT.NOT_AUTHENTICATED,e.TOPIC.ERROR,d),1)),!this.hasListeners("error"))throw console.log("--- You can catch all deepstream errors by subscribing to the error event ---"),d=b+": "+c,a&&(d+=" ("+a+")"),new Error(d);this.emit("error",c,b,a),this.emit(b,a,c)},n.prototype._onErrorMessage=function(a){this._$onError(a.topic,a.data[0],a.data[1])},n.prototype._getOptions=function(a){var b,c={};for(b in m)"undefined"==typeof a[b]?c[b]=m[b]:c[b]=a[b];return c},n.prototype.CONSTANTS=e,d.CONSTANTS=e,n.prototype.MERGE_STRATEGIES=f,d.MERGE_STRATEGIES=f,b.exports=d},{"./constants/constants":11,"./constants/merge-strategies":12,"./default-options":13,"./event/event-handler":14,"./message/connection":15,"./message/message-builder":16,"./presence/presence-handler":18,"./record/record-handler":22,"./rpc/rpc-handler":24,"component-emitter":2}],11:[function(a,b,c){c.CONNECTION_STATE={},c.CONNECTION_STATE.CLOSED="CLOSED",c.CONNECTION_STATE.AWAITING_CONNECTION="AWAITING_CONNECTION",c.CONNECTION_STATE.CHALLENGING="CHALLENGING",c.CONNECTION_STATE.AWAITING_AUTHENTICATION="AWAITING_AUTHENTICATION",c.CONNECTION_STATE.AUTHENTICATING="AUTHENTICATING",c.CONNECTION_STATE.OPEN="OPEN",c.CONNECTION_STATE.ERROR="ERROR",c.CONNECTION_STATE.RECONNECTING="RECONNECTING",c.MESSAGE_SEPERATOR=String.fromCharCode(30),c.MESSAGE_PART_SEPERATOR=String.fromCharCode(31),c.TYPES={},c.TYPES.STRING="S",c.TYPES.OBJECT="O",c.TYPES.NUMBER="N",c.TYPES.NULL="L",c.TYPES.TRUE="T",c.TYPES.FALSE="F",c.TYPES.UNDEFINED="U",c.TOPIC={},c.TOPIC.CONNECTION="C",c.TOPIC.AUTH="A",c.TOPIC.ERROR="X",c.TOPIC.EVENT="E",c.TOPIC.RECORD="R",c.TOPIC.RPC="P",c.TOPIC.PRESENCE="U",c.TOPIC.PRIVATE="PRIVATE/",c.EVENT={},c.EVENT.CONNECTION_ERROR="connectionError",c.EVENT.CONNECTION_STATE_CHANGED="connectionStateChanged",c.EVENT.MAX_RECONNECTION_ATTEMPTS_REACHED="MAX_RECONNECTION_ATTEMPTS_REACHED",c.EVENT.CONNECTION_AUTHENTICATION_TIMEOUT="CONNECTION_AUTHENTICATION_TIMEOUT",c.EVENT.ACK_TIMEOUT="ACK_TIMEOUT",c.EVENT.NO_RPC_PROVIDER="NO_RPC_PROVIDER",c.EVENT.RESPONSE_TIMEOUT="RESPONSE_TIMEOUT",c.EVENT.DELETE_TIMEOUT="DELETE_TIMEOUT",c.EVENT.UNSOLICITED_MESSAGE="UNSOLICITED_MESSAGE",c.EVENT.MESSAGE_DENIED="MESSAGE_DENIED",c.EVENT.MESSAGE_PARSE_ERROR="MESSAGE_PARSE_ERROR",c.EVENT.VERSION_EXISTS="VERSION_EXISTS",c.EVENT.NOT_AUTHENTICATED="NOT_AUTHENTICATED",c.EVENT.MESSAGE_PERMISSION_ERROR="MESSAGE_PERMISSION_ERROR",c.EVENT.LISTENER_EXISTS="LISTENER_EXISTS",c.EVENT.NOT_LISTENING="NOT_LISTENING",c.EVENT.TOO_MANY_AUTH_ATTEMPTS="TOO_MANY_AUTH_ATTEMPTS",c.EVENT.IS_CLOSED="IS_CLOSED",c.EVENT.RECORD_NOT_FOUND="RECORD_NOT_FOUND",c.EVENT.NOT_SUBSCRIBED="NOT_SUBSCRIBED",c.ACTIONS={},c.ACTIONS.PING="PI",c.ACTIONS.PONG="PO",c.ACTIONS.ACK="A",c.ACTIONS.REDIRECT="RED",c.ACTIONS.CHALLENGE="CH",c.ACTIONS.CHALLENGE_RESPONSE="CHR",c.ACTIONS.READ="R",c.ACTIONS.CREATE="C",c.ACTIONS.UPDATE="U",c.ACTIONS.PATCH="P",c.ACTIONS.DELETE="D",c.ACTIONS.SUBSCRIBE="S",c.ACTIONS.UNSUBSCRIBE="US",c.ACTIONS.HAS="H",c.ACTIONS.SNAPSHOT="SN",c.ACTIONS.INVOKE="I",c.ACTIONS.SUBSCRIPTION_FOR_PATTERN_FOUND="SP",c.ACTIONS.SUBSCRIPTION_FOR_PATTERN_REMOVED="SR",c.ACTIONS.SUBSCRIPTION_HAS_PROVIDER="SH",c.ACTIONS.LISTEN="L",c.ACTIONS.UNLISTEN="UL",c.ACTIONS.LISTEN_ACCEPT="LA",c.ACTIONS.LISTEN_REJECT="LR",c.ACTIONS.PROVIDER_UPDATE="PU",c.ACTIONS.QUERY="Q",c.ACTIONS.CREATEORREAD="CR",c.ACTIONS.EVENT="EVT",c.ACTIONS.ERROR="E",c.ACTIONS.REQUEST="REQ",c.ACTIONS.RESPONSE="RES",c.ACTIONS.REJECTION="REJ",c.ACTIONS.PRESENCE_JOIN="PNJ",c.ACTIONS.PRESENCE_LEAVE="PNL",c.ACTIONS.QUERY="Q",c.ACTIONS.WRITE_ACKNOWLEDGEMENT="WA",c.CALL_STATE={},c.CALL_STATE.INITIAL="INITIAL",c.CALL_STATE.CONNECTING="CONNECTING",c.CALL_STATE.ESTABLISHED="ESTABLISHED",c.CALL_STATE.ACCEPTED="ACCEPTED",c.CALL_STATE.DECLINED="DECLINED",c.CALL_STATE.ENDED="ENDED",c.CALL_STATE.ERROR="ERROR"},{}],12:[function(a,b,c){b.exports={REMOTE_WINS:function(a,b,c,d){d(null,b)},LOCAL_WINS:function(a,b,c,d){d(null,a.get())}}},{}],13:[function(a,b,c){var d=a("./constants/merge-strategies");b.exports={heartbeatInterval:3e4,recordPersistDefault:!0,reconnectIntervalIncrement:4e3,maxReconnectInterval:18e4,maxReconnectAttempts:5,rpcAckTimeout:6e3,rpcResponseTimeout:1e4,subscriptionTimeout:2e3,maxMessagesPerPacket:100,timeBetweenSendingQueuedPackages:16,recordReadAckTimeout:1e3,recordReadTimeout:3e3,recordDeleteTimeout:3e3,path:"/deepstream",mergeStrategy:d.REMOTE_WINS,recordDeepCopy:!0,nodeSocketOptions:null}},{"./constants/merge-strategies":12}],14:[function(a,b,c){var d=a("../message/message-builder"),e=a("../message/message-parser"),f=a("../utils/ack-timeout-registry"),g=a("../utils/resubscribe-notifier"),h=a("../constants/constants"),i=a("../utils/listener"),j=a("component-emitter"),k=function(a,b,c){this._options=a,this._connection=b,this._client=c,this._emitter=new j,this._listener={},this._ackTimeoutRegistry=new f(c,h.TOPIC.EVENT,this._options.subscriptionTimeout),this._resubscribeNotifier=new g(this._client,this._resubscribe.bind(this))};k.prototype.subscribe=function(a,b){if("string"!=typeof a||0===a.length)throw new Error("invalid argument name");if("function"!=typeof b)throw new Error("invalid argument callback");this._emitter.hasListeners(a)||(this._ackTimeoutRegistry.add(a,h.ACTIONS.SUBSCRIBE),this._connection.sendMsg(h.TOPIC.EVENT,h.ACTIONS.SUBSCRIBE,[a])),this._emitter.on(a,b)},k.prototype.unsubscribe=function(a,b){if("string"!=typeof a||0===a.length)throw new Error("invalid argument name");if(void 0!==b&&"function"!=typeof b)throw new Error("invalid argument callback");this._emitter.off(a,b),this._emitter.hasListeners(a)||(this._ackTimeoutRegistry.add(a,h.ACTIONS.UNSUBSCRIBE),this._connection.sendMsg(h.TOPIC.EVENT,h.ACTIONS.UNSUBSCRIBE,[a]))},k.prototype.emit=function(a,b){if("string"!=typeof a||0===a.length)throw new Error("invalid argument name");this._connection.sendMsg(h.TOPIC.EVENT,h.ACTIONS.EVENT,[a,d.typed(b)]),this._emitter.emit(a,b)},k.prototype.listen=function(a,b){if("string"!=typeof a||0===a.length)throw new Error("invalid argument pattern");if("function"!=typeof b)throw new Error("invalid argument callback");return this._listener[a]&&!this._listener[a].destroyPending?this._client._$onError(h.TOPIC.EVENT,h.EVENT.LISTENER_EXISTS,a):(this._listener[a]&&this._listener[a].destroy(),void(this._listener[a]=new i(h.TOPIC.EVENT,a,b,this._options,this._client,this._connection)))},k.prototype.unlisten=function(a){if("string"!=typeof a||0===a.length)throw new Error("invalid argument pattern");var b=this._listener[a];b&&!b.destroyPending?b.sendDestroy():this._listener[a]?(this._ackTimeoutRegistry.add(a,h.EVENT.UNLISTEN),this._listener[a].destroy(),delete this._listener[a]):this._client._$onError(h.TOPIC.RECORD,h.EVENT.NOT_LISTENING,a)},k.prototype._$handle=function(a){var b=a.data[a.action===h.ACTIONS.ACK?1:0];if(a.action===h.ACTIONS.EVENT)return processed=!0,void(a.data&&2===a.data.length?this._emitter.emit(b,e.convertTyped(a.data[1],this._client)):this._emitter.emit(b));if(a.action===h.ACTIONS.ACK&&a.data[0]===h.ACTIONS.UNLISTEN&&this._listener[b]&&this._listener[b].destroyPending)return this._listener[b].destroy(),void delete this._listener[b];if(this._listener[b])return processed=!0,void this._listener[b]._$onMessage(a);if(a.action!==h.ACTIONS.SUBSCRIPTION_FOR_PATTERN_REMOVED&&a.action!==h.ACTIONS.SUBSCRIPTION_HAS_PROVIDER)return a.action===h.ACTIONS.ACK?void this._ackTimeoutRegistry.clear(a):a.action===h.ACTIONS.ERROR?(a.data[0]===h.EVENT.MESSAGE_DENIED?this._ackTimeoutRegistry.remove(a.data[1],a.data[2]):a.data[0]===h.EVENT.NOT_SUBSCRIBED&&this._ackTimeoutRegistry.remove(a.data[1],h.ACTIONS.UNSUBSCRIBE),a.processedError=!0,void this._client._$onError(h.TOPIC.EVENT,a.data[0],a.data[1])):void this._client._$onError(h.TOPIC.EVENT,h.EVENT.UNSOLICITED_MESSAGE,b)},k.prototype._resubscribe=function(){var a=this._emitter._callbacks;for(var b in a)this._connection.sendMsg(h.TOPIC.EVENT,h.ACTIONS.SUBSCRIBE,[b])},b.exports=k},{"../constants/constants":11,"../message/message-builder":16,"../message/message-parser":17,"../utils/ack-timeout-registry":27,"../utils/listener":28,"../utils/resubscribe-notifier":29,"component-emitter":2}],15:[function(a,b,c){(function(c){var d=c.WebSocket||c.MozWebSocket,e=a("ws"),f=a("./message-parser"),g=a("./message-builder"),h=a("../utils/utils"),i=a("../constants/constants"),j=function(a,b,c){this._client=a,this._options=c,this._authParams=null,this._authCallback=null,this._deliberateClose=!1,this._redirecting=!1,this._tooManyAuthAttempts=!1,this._connectionAuthenticationTimeout=!1,this._challengeDenied=!1,this._queuedMessages=[],this._reconnectTimeout=null,this._reconnectionAttempt=0,this._currentPacketMessageCount=0,this._sendNextPacketTimeout=null,this._currentMessageResetTimeout=null,this._endpoint=null,this._lastHeartBeat=null,this._heartbeatInterval=null,this._originalUrl=h.parseUrl(b,this._options.path),this._url=this._originalUrl,this._state=i.CONNECTION_STATE.CLOSED,this._createEndpoint()};j.prototype.getState=function(){return this._state},j.prototype.authenticate=function(a,b){return this._authParams=a,this._authCallback=b,this._tooManyAuthAttempts||this._challengeDenied||this._connectionAuthenticationTimeout?void this._client._$onError(i.TOPIC.ERROR,i.EVENT.IS_CLOSED,"this client's connection was closed"):this._deliberateClose===!0&&this._state===i.CONNECTION_STATE.CLOSED?(this._createEndpoint(),void(this._deliberateClose=!1)):void(this._state===i.CONNECTION_STATE.AWAITING_AUTHENTICATION&&this._sendAuthParams())},j.prototype.sendMsg=function(a,b,c){this.send(g.getMsg(a,b,c))},j.prototype.send=function(a){this._queuedMessages.push(a),this._currentPacketMessageCount++,null===this._currentMessageResetTimeout&&(this._currentMessageResetTimeout=h.nextTick(this._resetCurrentMessageCount.bind(this))),this._state===i.CONNECTION_STATE.OPEN&&this._queuedMessages.length<this._options.maxMessagesPerPacket&&this._currentPacketMessageCount<this._options.maxMessagesPerPacket?this._sendQueuedMessages():null===this._sendNextPacketTimeout&&this._queueNextPacket()},j.prototype.close=function(){clearInterval(this._heartbeatInterval),this._deliberateClose=!0,this._endpoint.close()},j.prototype._createEndpoint=function(){this._endpoint=d?new d(this._url):new e(this._url,this._options.nodeSocketOptions),this._endpoint.onopen=this._onOpen.bind(this),this._endpoint.onerror=this._onError.bind(this),this._endpoint.onclose=this._onClose.bind(this),this._endpoint.onmessage=this._onMessage.bind(this)},j.prototype._resetCurrentMessageCount=function(){this._currentPacketMessageCount=0,this._currentMessageResetTimeout=null},j.prototype._sendQueuedMessages=function(){if(this._state===i.CONNECTION_STATE.OPEN&&this._endpoint.readyState===this._endpoint.OPEN){if(0===this._queuedMessages.length)return void(this._sendNextPacketTimeout=null);var a=this._queuedMessages.splice(0,this._options.maxMessagesPerPacket).join("");0!==this._queuedMessages.length?this._queueNextPacket():this._sendNextPacketTimeout=null,this._submit(a)}},j.prototype._submit=function(a){this._endpoint.readyState===this._endpoint.OPEN?this._endpoint.send(a):this._onError("Tried to send message on a closed websocket connection")},j.prototype._queueNextPacket=function(){var a=this._sendQueuedMessages.bind(this),b=this._options.timeBetweenSendingQueuedPackages;this._sendNextPacketTimeout=setTimeout(a,b)},j.prototype._sendAuthParams=function(){this._setState(i.CONNECTION_STATE.AUTHENTICATING);var a=g.getMsg(i.TOPIC.AUTH,i.ACTIONS.REQUEST,[this._authParams]);this._submit(a)},j.prototype._checkHeartBeat=function(){var a=2*this._options.heartbeatInterval;Date.now()-this._lastHeartBeat>a&&(clearInterval(this._heartbeatInterval),this._endpoint.close(),this._onError("Two connections heartbeats missed successively"))},j.prototype._onOpen=function(){this._clearReconnect(),this._lastHeartBeat=Date.now(),this._heartbeatInterval=h.setInterval(this._checkHeartBeat.bind(this),this._options.heartbeatInterval),this._setState(i.CONNECTION_STATE.AWAITING_CONNECTION)},j.prototype._onError=function(a){clearInterval(this._heartbeatInterval),this._setState(i.CONNECTION_STATE.ERROR),setTimeout(function(){var b;b="ECONNRESET"===a.code||"ECONNREFUSED"===a.code?"Can't connect! Deepstream server unreachable on "+this._originalUrl:a.toString(),this._client._$onError(i.TOPIC.CONNECTION,i.EVENT.CONNECTION_ERROR,b)}.bind(this),1)},j.prototype._onClose=function(){clearInterval(this._heartbeatInterval),this._redirecting===!0?(this._redirecting=!1,this._createEndpoint()):this._deliberateClose===!0?this._setState(i.CONNECTION_STATE.CLOSED):this._tryReconnect()},j.prototype._onMessage=function(a){var b,c=f.parse(a.data,this._client);for(b=0;b<c.length;b++)null!==c[b]&&(c[b].topic===i.TOPIC.CONNECTION?this._handleConnectionResponse(c[b]):c[b].topic===i.TOPIC.AUTH?this._handleAuthResponse(c[b]):this._client._$onMessage(c[b]))},j.prototype._handleConnectionResponse=function(a){a.action===i.ACTIONS.PING?(this._lastHeartBeat=Date.now(),this._submit(g.getMsg(i.TOPIC.CONNECTION,i.ACTIONS.PONG))):a.action===i.ACTIONS.ACK?(this._setState(i.CONNECTION_STATE.AWAITING_AUTHENTICATION),this._authParams&&this._sendAuthParams()):a.action===i.ACTIONS.CHALLENGE?(this._setState(i.CONNECTION_STATE.CHALLENGING),this._submit(g.getMsg(i.TOPIC.CONNECTION,i.ACTIONS.CHALLENGE_RESPONSE,[this._originalUrl]))):a.action===i.ACTIONS.REJECTION?(this._challengeDenied=!0,this.close()):a.action===i.ACTIONS.REDIRECT?(this._url=a.data[0],this._redirecting=!0,this._endpoint.close()):a.action===i.ACTIONS.ERROR&&a.data[0]===i.EVENT.CONNECTION_AUTHENTICATION_TIMEOUT&&(this._deliberateClose=!0,this._connectionAuthenticationTimeout=!0,this._client._$onError(i.TOPIC.CONNECTION,a.data[0],a.data[1]))},j.prototype._handleAuthResponse=function(a){a.action===i.ACTIONS.ERROR?(a.data[0]===i.EVENT.TOO_MANY_AUTH_ATTEMPTS?(this._deliberateClose=!0,this._tooManyAuthAttempts=!0):this._setState(i.CONNECTION_STATE.AWAITING_AUTHENTICATION),this._authCallback&&this._authCallback(!1,this._getAuthData(a.data[1]))):a.action===i.ACTIONS.ACK&&(this._setState(i.CONNECTION_STATE.OPEN),this._authCallback&&this._authCallback(!0,this._getAuthData(a.data[0])),
this._sendQueuedMessages())},j.prototype._getAuthData=function(a){return void 0===a?null:f.convertTyped(a,this._client)},j.prototype._setState=function(a){this._state=a,this._client.emit(i.EVENT.CONNECTION_STATE_CHANGED,a)},j.prototype._tryReconnect=function(){null===this._reconnectTimeout&&(this._reconnectionAttempt<this._options.maxReconnectAttempts?(this._setState(i.CONNECTION_STATE.RECONNECTING),this._reconnectTimeout=setTimeout(this._tryOpen.bind(this),Math.min(this._options.maxReconnectInterval,this._options.reconnectIntervalIncrement*this._reconnectionAttempt)),this._reconnectionAttempt++):(this._clearReconnect(),this.close(),this._client.emit(i.MAX_RECONNECTION_ATTEMPTS_REACHED,this._reconnectionAttempt)))},j.prototype._tryOpen=function(){this._originalUrl!==this._url&&(this._url=this._originalUrl),this._createEndpoint(),this._reconnectTimeout=null},j.prototype._clearReconnect=function(){clearTimeout(this._reconnectTimeout),this._reconnectTimeout=null,this._reconnectionAttempt=0},b.exports=j}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../constants/constants":11,"../utils/utils":31,"./message-builder":16,"./message-parser":17,ws:1}],16:[function(a,b,c){var d=a("../constants/constants"),e=d.MESSAGE_PART_SEPERATOR;c.getMsg=function(a,b,c){if(c&&!(c instanceof Array))throw new Error("data must be an array");var f,g=[a,b];if(c)for(f=0;f<c.length;f++)"object"==typeof c[f]?g.push(JSON.stringify(c[f])):g.push(c[f]);return g.join(e)+d.MESSAGE_SEPERATOR},c.typed=function(a){var b=typeof a;if("string"===b)return d.TYPES.STRING+a;if(null===a)return d.TYPES.NULL;if("object"===b)return d.TYPES.OBJECT+JSON.stringify(a);if("number"===b)return d.TYPES.NUMBER+a.toString();if(a===!0)return d.TYPES.TRUE;if(a===!1)return d.TYPES.FALSE;if(void 0===a)return d.TYPES.UNDEFINED;throw new Error("Can't serialize type "+a)}},{"../constants/constants":11}],17:[function(a,b,c){var d=a("../constants/constants"),e=function(){this._actions=this._getActions()};e.prototype.parse=function(a,b){var c,e=[],f=a.split(d.MESSAGE_SEPERATOR);for(c=0;c<f.length;c++)f[c].length>2&&e.push(this._parseMessage(f[c],b));return e},e.prototype.convertTyped=function(a,b){var c=a.charAt(0);if(c===d.TYPES.STRING)return a.substr(1);if(c===d.TYPES.OBJECT)try{return JSON.parse(a.substr(1))}catch(c){return void b._$onError(d.TOPIC.ERROR,d.EVENT.MESSAGE_PARSE_ERROR,c.toString()+"("+a+")")}return c===d.TYPES.NUMBER?parseFloat(a.substr(1)):c===d.TYPES.NULL?null:c===d.TYPES.TRUE||c!==d.TYPES.FALSE&&void(c!==d.TYPES.UNDEFINED&&b._$onError(d.TOPIC.ERROR,d.EVENT.MESSAGE_PARSE_ERROR,"UNKNOWN_TYPE ("+a+")"))},e.prototype._getActions=function(){var a,b={};for(a in d.ACTIONS)b[d.ACTIONS[a]]=a;return b},e.prototype._parseMessage=function(a,b){var c=a.split(d.MESSAGE_PART_SEPERATOR),e={};return c.length<2?(a.processedError=!0,b._$onError(d.TOPIC.ERROR,d.EVENT.MESSAGE_PARSE_ERROR,"Insufficiant message parts"),null):void 0===this._actions[c[1]]?(a.processedError=!0,b._$onError(d.TOPIC.ERROR,d.EVENT.MESSAGE_PARSE_ERROR,"Unknown action "+c[1]),null):(e.raw=a,e.topic=c[0],e.action=c[1],e.data=c.splice(2),e)},b.exports=new e},{"../constants/constants":11}],18:[function(a,b,c){var d=a("component-emitter"),e=a("../constants/constants"),f=a("../utils/ack-timeout-registry"),g=(a("../message/message-parser"),a("../message/message-builder"),a("../utils/resubscribe-notifier")),h=function(a,b,c){this._options=a,this._connection=b,this._client=c,this._emitter=new d,this._ackTimeoutRegistry=new f(c,e.TOPIC.PRESENCE,this._options.subscriptionTimeout),this._resubscribeNotifier=new g(this._client,this._resubscribe.bind(this))};h.prototype.getAll=function(a){this._emitter.hasListeners(e.ACTIONS.QUERY)||this._connection.sendMsg(e.TOPIC.PRESENCE,e.ACTIONS.QUERY,[e.ACTIONS.QUERY]),this._emitter.once(e.ACTIONS.QUERY,a)},h.prototype.subscribe=function(a){if(void 0!==a&&"function"!=typeof a)throw new Error("invalid argument callback");this._emitter.hasListeners(e.TOPIC.PRESENCE)||(this._ackTimeoutRegistry.add(e.TOPIC.PRESENCE,e.ACTIONS.SUBSCRIBE),this._connection.sendMsg(e.TOPIC.PRESENCE,e.ACTIONS.SUBSCRIBE,[e.ACTIONS.SUBSCRIBE])),this._emitter.on(e.TOPIC.PRESENCE,a)},h.prototype.unsubscribe=function(a){if(void 0!==a&&"function"!=typeof a)throw new Error("invalid argument callback");this._emitter.off(e.TOPIC.PRESENCE,a),this._emitter.hasListeners(e.TOPIC.PRESENCE)||(this._ackTimeoutRegistry.add(e.TOPIC.PRESENCE,e.ACTIONS.UNSUBSCRIBE),this._connection.sendMsg(e.TOPIC.PRESENCE,e.ACTIONS.UNSUBSCRIBE,[e.ACTIONS.UNSUBSCRIBE]))},h.prototype._$handle=function(a){a.action===e.ACTIONS.ERROR&&a.data[0]===e.EVENT.MESSAGE_DENIED?(this._ackTimeoutRegistry.remove(e.TOPIC.PRESENCE,a.data[1]),a.processedError=!0,this._client._$onError(e.TOPIC.PRESENCE,e.EVENT.MESSAGE_DENIED,a.data[1])):a.action===e.ACTIONS.ACK?this._ackTimeoutRegistry.clear(a):a.action===e.ACTIONS.PRESENCE_JOIN?this._emitter.emit(e.TOPIC.PRESENCE,a.data[0],!0):a.action===e.ACTIONS.PRESENCE_LEAVE?this._emitter.emit(e.TOPIC.PRESENCE,a.data[0],!1):a.action===e.ACTIONS.QUERY?this._emitter.emit(e.ACTIONS.QUERY,a.data):this._client._$onError(e.TOPIC.PRESENCE,e.EVENT.UNSOLICITED_MESSAGE,a.action)},h.prototype._resubscribe=function(){var a=this._emitter._callbacks;a&&a[e.TOPIC.PRESENCE]&&this._connection.sendMsg(e.TOPIC.PRESENCE,e.ACTIONS.SUBSCRIBE,[e.ACTIONS.SUBSCRIBE])},b.exports=h},{"../constants/constants":11,"../message/message-builder":16,"../message/message-parser":17,"../utils/ack-timeout-registry":27,"../utils/resubscribe-notifier":29,"component-emitter":2}],19:[function(a,b,c){var d=a("./record"),e=a("component-emitter"),f=function(a){this.name=null,this._recordHandler=a,this._record=null,this._subscriptions=[],this._proxyMethod("delete"),this._proxyMethod("set"),this._proxyMethod("discard")};e(f.prototype),f.prototype.get=function(a){if(null!==this._record)return this._record.get(a)},f.prototype.subscribe=function(){var a=d.prototype._normalizeArguments(arguments);a.triggerNow=!0,this._subscriptions.push(a),null!==this._record&&this._record.subscribe(a)},f.prototype.unsubscribe=function(){var a,b=d.prototype._normalizeArguments(arguments),c=[];for(a=0;a<this._subscriptions.length;a++)this._subscriptions[a].path===b.path&&this._subscriptions[a].callback===b.callback||c.push(this._subscriptions[a]);this._subscriptions=c,null!==this._record&&this._record.unsubscribe(b)},f.prototype.setName=function(a){this.name=a;var b;if(null!==this._record&&!this._record.isDestroyed){for(b=0;b<this._subscriptions.length;b++)this._record.unsubscribe(this._subscriptions[b]);this._record.discard()}for(this._record=this._recordHandler.getRecord(a),b=0;b<this._subscriptions.length;b++)this._record.subscribe(this._subscriptions[b]);this._record.whenReady(this.emit.bind(this,"ready")),this.emit("nameChanged",a)},f.prototype._proxyMethod=function(a){this[a]=this._callMethodOnRecord.bind(this,a)},f.prototype._callMethodOnRecord=function(a){if(null===this._record)throw new Error("Can`t invoke "+a+". AnonymousRecord not initialised. Call setName first");if("function"!=typeof this._record[a])throw new Error(a+" is not a method on the record");var b=Array.prototype.slice.call(arguments,1);return this._record[a].apply(this._record,b)},b.exports=f},{"./record":23,"component-emitter":2}],20:[function(a,b,c){function d(a,b,c){var e;if(f.deepEquals(a,b))return a;if(null===a||null===b)return b;if(Array.isArray(a)&&Array.isArray(b)){var g=[];for(e=0;e<b.length;e++)g[e]=d(a[e],b[e],c);return g}if(Array.isArray(b)||"object"!=typeof a||"object"!=typeof b)return c!==!1?f.deepCopy(b):b;var h=Object.keys(b),i=Object.create(null);for(e=0;e<h.length;e++)i[h[e]]=d(a[h[e]],b[h[e]],c);return i}function e(a){if(h[a])return h[a];var b="undefined"!==String(a)?String(a).match(g):[];if(!b)throw new Error("invalid path "+a);return h[a]=b.map(function(a){return isNaN(a)?a:parseInt(a,10)})}var f=a("../utils/utils"),g=/([^\.\[\]\s]+)/g,h=Object.create(null);b.exports.get=function(a,b,c){for(var d=e(b),g=0;g<d.length;g++){if(void 0===a)return;if("object"!=typeof a)throw new Error("invalid data or path");a=a[d[g]]}return c!==!1?f.deepCopy(a):a},b.exports.set=function(a,c,g,h){var i=e(c);if(0===i.length)return d(a,g,h);var j=b.exports.get(a,c,!1),k=d(j,g,h);if(k===j)return a;for(var l=f.shallowCopy(a),m=l,n=0;n<i.length;n++)n===i.length-1?m[i[n]]=k:m=void 0!==m[i[n]]?m[i[n]]=f.shallowCopy(m[i[n]]):i[n+1]&&!isNaN(i[n+1])?m[i[n]]=[]:m[i[n]]=Object.create(null);return l}},{"../utils/utils":31}],21:[function(a,b,c){var d=a("component-emitter"),e=a("./record"),f=a("../constants/constants"),g="entry-added",h="entry-removed",i="entry-moved",j=function(a,b,c){if("string"!=typeof b||0===b.length)throw new Error("invalid argument name");this._recordHandler=a,this._record=this._recordHandler.getRecord(b,c),this._record._applyUpdate=this._applyUpdate.bind(this),this._record.on("delete",this.emit.bind(this,"delete")),this._record.on("discard",this._onDiscard.bind(this)),this._record.on("ready",this._onReady.bind(this)),this.isDestroyed=this._record.isDestroyed,this.isReady=this._record.isReady,this.name=b,this._queuedMethods=[],this._beforeStructure=null,this._hasAddListener=null,this._hasRemoveListener=null,this._hasMoveListener=null,this.delete=this._record.delete.bind(this._record),this.discard=this._record.discard.bind(this._record),this.whenReady=this._record.whenReady.bind(this)};d(j.prototype),j.prototype.getEntries=function(){var a=this._record.get();return a instanceof Array?a:[]},j.prototype.isEmpty=function(){return 0===this.getEntries().length},j.prototype.setEntries=function(a){var b,c="entries must be an array of record names";if(!(a instanceof Array))throw new Error(c);for(b=0;b<a.length;b++)if("string"!=typeof a[b])throw new Error(c);this._record.isReady===!1?this._queuedMethods.push(this.setEntries.bind(this,a)):(this._beforeChange(),this._record.set(a),this._afterChange())},j.prototype.removeEntry=function(a,b){if(this._record.isReady===!1)return void this._queuedMethods.push(this.removeEntry.bind(this,a));var c,d=this._record.get(),e=this._hasIndex(b),f=[];for(c=0;c<d.length;c++)(d[c]!==a||e&&b!==c)&&f.push(d[c]);this._beforeChange(),this._record.set(f),this._afterChange()},j.prototype.addEntry=function(a,b){if("string"!=typeof a)throw new Error("Entry must be a recordName");if(this._record.isReady===!1)return void this._queuedMethods.push(this.addEntry.bind(this,a));var c=this._hasIndex(b),d=this.getEntries();c?d.splice(b,0,a):d.push(a),this._beforeChange(),this._record.set(d),this._afterChange()},j.prototype.subscribe=function(){var a=e.prototype._normalizeArguments(arguments);if(a.path)throw new Error("path is not supported for List.subscribe");var b=function(a){a(this.getEntries())}.bind(this,a.callback);a.callback.wrappedCallback=b,a.callback=b,this._record.subscribe(a)},j.prototype.unsubscribe=function(){var a=e.prototype._normalizeArguments(arguments);if(a.path)throw new Error("path is not supported for List.unsubscribe");a.callback=a.callback.wrappedCallback,this._record.unsubscribe(a)},j.prototype._onReady=function(){this.isReady=!0;for(var a=0;a<this._queuedMethods.length;a++)this._queuedMethods[a]();this.emit("ready")},j.prototype._onDiscard=function(){this.isDestroyed=!0,this.emit("discard")},j.prototype._applyUpdate=function(a){if(a.action===f.ACTIONS.PATCH)throw new Error("PATCH is not supported for Lists");"["!==a.data[2].charAt(0)&&(a.data[2]="[]"),this._beforeChange(),e.prototype._applyUpdate.call(this._record,a),this._afterChange()},j.prototype._hasIndex=function(a){var b=!1,c=this.getEntries();if(void 0!==a){if(isNaN(a))throw new Error("Index must be a number");if(a!==c.length&&(a>=c.length||a<0))throw new Error("Index must be within current entries");b=!0}return b},j.prototype._beforeChange=function(){this._hasAddListener=this.listeners(g).length>0,this._hasRemoveListener=this.listeners(h).length>0,this._hasMoveListener=this.listeners(i).length>0,this._hasAddListener||this._hasRemoveListener||this._hasMoveListener?this._beforeStructure=this._getStructure():this._beforeStructure=null},j.prototype._afterChange=function(){if(null!==this._beforeStructure){var a,b,c=this._getStructure(),d=this._beforeStructure;if(this._hasRemoveListener)for(a in d)for(b=0;b<d[a].length;b++)void 0!==c[a]&&void 0!==c[a][b]||this.emit(h,a,d[a][b]);if(this._hasAddListener||this._hasMoveListener)for(a in c)if(void 0===d[a])for(b=0;b<c[a].length;b++)this.emit(g,a,c[a][b]);else for(b=0;b<c[a].length;b++)d[a][b]!==c[a][b]&&(void 0===d[a][b]?this.emit(g,a,c[a][b]):this.emit(i,a,c[a][b]))}},j.prototype._getStructure=function(){var a,b={},c=this._record.get();for(a=0;a<c.length;a++)void 0===b[c[a]]?b[c[a]]=[a]:b[c[a]].push(a);return b},b.exports=j},{"../constants/constants":11,"./record":23,"component-emitter":2}],22:[function(a,b,c){var d=a("./record"),e=a("./anonymous-record"),f=a("./list"),g=a("../utils/listener"),h=a("../utils/single-notifier"),i=a("../constants/constants"),j=a("../message/message-parser"),k=a("component-emitter"),l=function(a,b,c){this._options=a,this._connection=b,this._client=c,this._records={},this._lists={},this._listener={},this._destroyEventEmitter=new k,this._hasRegistry=new h(c,b,i.TOPIC.RECORD,i.ACTIONS.HAS,this._options.recordReadTimeout),this._snapshotRegistry=new h(c,b,i.TOPIC.RECORD,i.ACTIONS.SNAPSHOT,this._options.recordReadTimeout)};l.prototype.getRecord=function(a,b){return this._records[a]||(this._records[a]=new d(a,b||{},this._connection,this._options,this._client),this._records[a].on("error",this._onRecordError.bind(this,a)),this._records[a].on("destroyPending",this._onDestroyPending.bind(this,a)),this._records[a].on("delete",this._removeRecord.bind(this,a)),this._records[a].on("discard",this._removeRecord.bind(this,a))),this._records[a].usages++,this._records[a]},l.prototype.getList=function(a,b){return this._lists[a]?this._records[a].usages++:this._lists[a]=new f(this,a,b),this._lists[a]},l.prototype.getAnonymousRecord=function(){return new e(this)},l.prototype.listen=function(a,b){if("string"!=typeof a||0===a.length)throw new Error("invalid argument pattern");if("function"!=typeof b)throw new Error("invalid argument callback");return this._listener[a]&&!this._listener[a].destroyPending?this._client._$onError(i.TOPIC.RECORD,i.EVENT.LISTENER_EXISTS,a):(this._listener[a]&&this._listener[a].destroy(),void(this._listener[a]=new g(i.TOPIC.RECORD,a,b,this._options,this._client,this._connection)))},l.prototype.unlisten=function(a){if("string"!=typeof a||0===a.length)throw new Error("invalid argument pattern");var b=this._listener[a];b&&!b.destroyPending?b.sendDestroy():this._listener[a]?(this._listener[a].destroy(),delete this._listener[a]):this._client._$onError(i.TOPIC.RECORD,i.EVENT.NOT_LISTENING,a)},l.prototype.snapshot=function(a,b){if("string"!=typeof a||0===a.length)throw new Error("invalid argument name");this._records[a]&&this._records[a].isReady?b(null,this._records[a].get()):this._snapshotRegistry.request(a,b)},l.prototype.has=function(a,b){if("string"!=typeof a||0===a.length)throw new Error("invalid argument name");this._records[a]?b(null,!0):this._hasRegistry.request(a,b)},l.prototype._$handle=function(a){var b;if(a.action===i.ACTIONS.ERROR&&a.data[0]!==i.EVENT.VERSION_EXISTS&&a.data[0]!==i.ACTIONS.SNAPSHOT&&a.data[0]!==i.ACTIONS.HAS&&a.data[0]!==i.EVENT.MESSAGE_DENIED)return a.processedError=!0,void this._client._$onError(i.TOPIC.RECORD,a.data[0],a.data[1]);if(a.action===i.ACTIONS.ACK||a.action===i.ACTIONS.ERROR){if(b=a.data[1],a.data[0]===i.ACTIONS.DELETE||a.data[0]===i.ACTIONS.UNSUBSCRIBE||a.data[0]===i.EVENT.MESSAGE_DENIED&&a.data[2]===i.ACTIONS.DELETE)return this._destroyEventEmitter.emit("destroy_ack_"+b,a),void(a.data[0]===i.ACTIONS.DELETE&&this._records[b]&&this._records[b]._$onMessage(a));if(a.data[0]===i.ACTIONS.SNAPSHOT)return a.processedError=!0,void this._snapshotRegistry.recieve(b,a.data[2]);if(a.data[0]===i.ACTIONS.HAS)return a.processedError=!0,void this._snapshotRegistry.recieve(b,a.data[2])}else b=a.data[0];var c=!1;this._records[b]&&(c=!0,this._records[b]._$onMessage(a)),a.action===i.ACTIONS.READ&&this._snapshotRegistry.hasRequest(b)&&(c=!0,this._snapshotRegistry.recieve(b,null,JSON.parse(a.data[2]))),a.action===i.ACTIONS.HAS&&this._hasRegistry.hasRequest(b)&&(c=!0,this._hasRegistry.recieve(b,null,j.convertTyped(a.data[1]))),a.action===i.ACTIONS.ACK&&a.data[0]===i.ACTIONS.UNLISTEN&&this._listener[b]&&this._listener[b].destroyPending?(c=!0,this._listener[b].destroy(),delete this._listener[b]):this._listener[b]?(c=!0,this._listener[b]._$onMessage(a)):a.action===i.ACTIONS.SUBSCRIPTION_FOR_PATTERN_REMOVED?c=!0:a.action===i.ACTIONS.SUBSCRIPTION_HAS_PROVIDER&&(c=!0),c||(a.processedError=!0,this._client._$onError(i.TOPIC.RECORD,i.EVENT.UNSOLICITED_MESSAGE,b))},l.prototype._onRecordError=function(a,b){this._client._$onError(i.TOPIC.RECORD,b,a)},l.prototype._onDestroyPending=function(a){if(!this._records[a])return void this.emit("error","Record '"+a+"' does not exists");var b=this._records[a]._$onMessage.bind(this._records[a]);this._destroyEventEmitter.once("destroy_ack_"+a,b),this._removeRecord(a)},l.prototype._removeRecord=function(a){delete this._records[a],delete this._lists[a]},b.exports=l},{"../constants/constants":11,"../message/message-parser":17,"../utils/listener":28,"../utils/single-notifier":30,"./anonymous-record":19,"./list":21,"./record":23,"component-emitter":2}],23:[function(a,b,c){var d=a("./json-path"),e=(a("../utils/utils"),a("../utils/resubscribe-notifier")),f=a("component-emitter"),g=a("../constants/constants"),h=a("../message/message-builder"),i=a("../message/message-parser"),j=function(a,b,c,d,h){if("string"!=typeof a||0===a.length)throw new Error("invalid argument name");this.name=a,this.usages=0,this._recordOptions=b,this._connection=c,this._client=h,this._options=d,this.isReady=!1,this.isDestroyed=!1,this.hasProvider=!1,this._$data=Object.create(null),this.version=null,this._eventEmitter=new f,this._queuedMethodCalls=[],this._writeCallbacks={},this._mergeStrategy=null,d.mergeStrategy&&this.setMergeStrategy(d.mergeStrategy),this._resubscribeNotifier=new e(this._client,this._sendRead.bind(this)),this._readAckTimeout=setTimeout(this._onTimeout.bind(this,g.EVENT.ACK_TIMEOUT),this._options.recordReadAckTimeout),this._readTimeout=setTimeout(this._onTimeout.bind(this,g.EVENT.RESPONSE_TIMEOUT),this._options.recordReadTimeout),this._sendRead()};f(j.prototype),j.prototype.setMergeStrategy=function(a){if("function"!=typeof a)throw new Error("Invalid merge strategy: Must be a Function");this._mergeStrategy=a},j.prototype.get=function(a){return d.get(this._$data,a,this._options.recordDeepCopy)},j.prototype.set=function(a,b,c){var e,f;if(1===arguments.length){if("object"!=typeof a)throw new Error("invalid argument data");f=a}else if(2===arguments.length)if("string"==typeof a&&0!==a.length&&"function"!=typeof b)e=a,f=b;else{if("object"!=typeof a||"function"!=typeof b)throw new Error("invalid argument path");f=a,c=b}else if(3===arguments.length){if("string"!=typeof a||0===a.length||"function"!=typeof c)throw new Error("invalid arguments, must pass in a string, a value and a function");e=a,f=b}if(this._checkDestroyed("set"))return this;if(!this.isReady)return this._queuedMethodCalls.push({method:"set",args:arguments}),this;var h=this._$data,i=d.set(h,e,f,this._options.recordDeepCopy);if(h===i)return this;var j;if(void 0!==c){j={},j.writeSuccess=!0,this._setUpCallback(this.version,c);var k=this._client.getConnectionState();k!==g.CONNECTION_STATE.CLOSED&&k!==g.CONNECTION_STATE.RECONNECTING||c("Connection error: error updating record as connection was closed")}return this._sendUpdate(e,f,j),this._applyChange(i),this},j.prototype.subscribe=function(a,b,c){var d=this._normalizeArguments(arguments);if(void 0!==d.path&&("string"!=typeof d.path||0===d.path.length))throw new Error("invalid argument path");if("function"!=typeof d.callback)throw new Error("invalid argument callback");this._checkDestroyed("subscribe")||(d.triggerNow?this.whenReady(function(){this._eventEmitter.on(d.path,d.callback),d.callback(this.get(d.path))}.bind(this)):this._eventEmitter.on(d.path,d.callback))},j.prototype.unsubscribe=function(a,b){var c=this._normalizeArguments(arguments);if(void 0!==c.path&&("string"!=typeof c.path||0===c.path.length))throw new Error("invalid argument path");if(void 0!==c.callback&&"function"!=typeof c.callback)throw new Error("invalid argument callback");this._checkDestroyed("unsubscribe")||this._eventEmitter.off(c.path,c.callback)},j.prototype.discard=function(){this._checkDestroyed("discard")||this.whenReady(function(){this.usages--,this.usages<=0&&(this.emit("destroyPending"),this._discardTimeout=setTimeout(this._onTimeout.bind(this,g.EVENT.ACK_TIMEOUT),this._options.subscriptionTimeout),this._connection.sendMsg(g.TOPIC.RECORD,g.ACTIONS.UNSUBSCRIBE,[this.name]))}.bind(this))},j.prototype.delete=function(){this._checkDestroyed("delete")||this.whenReady(function(){this.emit("destroyPending"),this._deleteAckTimeout=setTimeout(this._onTimeout.bind(this,g.EVENT.DELETE_TIMEOUT),this._options.recordDeleteTimeout),this._connection.sendMsg(g.TOPIC.RECORD,g.ACTIONS.DELETE,[this.name])}.bind(this))},j.prototype.whenReady=function(a){this.isReady===!0?a(this):this.once("ready",a.bind(this,this))},j.prototype._$onMessage=function(a){if(a.action===g.ACTIONS.READ)null===this.version?(clearTimeout(this._readTimeout),this._onRead(a)):this._applyUpdate(a,this._client);else if(a.action===g.ACTIONS.ACK)this._processAckMessage(a);else if(a.action===g.ACTIONS.UPDATE||a.action===g.ACTIONS.PATCH)this._applyUpdate(a,this._client);else if(a.action===g.ACTIONS.WRITE_ACKNOWLEDGEMENT)for(var b=JSON.parse(a.data[1]),c=0;c<b.length;c++){var d=this._writeCallbacks[b[c]];void 0!==d&&(d(i.convertTyped(a.data[2],this._client)),delete this._writeCallbacks[b[c]])}else if(a.data[0]===g.EVENT.VERSION_EXISTS)this._recoverRecord(a.data[2],JSON.parse(a.data[3]),a);else if(a.data[0]===g.EVENT.MESSAGE_DENIED)this._clearTimeouts();else if(a.action===g.ACTIONS.SUBSCRIPTION_HAS_PROVIDER){var e=i.convertTyped(a.data[1],this._client);this.hasProvider=e,this.emit("hasProviderChanged",e)}},j.prototype._recoverRecord=function(a,b,c){c.processedError=!0,this._mergeStrategy?this._mergeStrategy(this,b,a,this._onRecordRecovered.bind(this,a,b,c)):this.emit("error",g.EVENT.VERSION_EXISTS,"received update for "+a+" but version is "+this.version)},j.prototype._sendUpdate=function(a,b,c){this.version++;var d;a?(d=void 0===c?[this.name,this.version,a,h.typed(b)]:[this.name,this.version,a,h.typed(b),c],this._connection.sendMsg(g.TOPIC.RECORD,g.ACTIONS.PATCH,d)):(d=void 0===c?[this.name,this.version,b]:[this.name,this.version,b,c],this._connection.sendMsg(g.TOPIC.RECORD,g.ACTIONS.UPDATE,d))},j.prototype._onRecordRecovered=function(a,b,c,e,f){if(e)this.emit("error",g.EVENT.VERSION_EXISTS,"received update for "+a+" but version is "+this.version);else{var h=this.version;this.version=a;var i=this._$data,j=d.set(i,void 0,f,!1);if(i===j)return;var k=c.data[4];if(k&&JSON.parse(k).writeSuccess){var l=this._writeCallbacks[h];delete this._writeCallbacks[h],this._setUpCallback(this.version,l)}this._sendUpdate(void 0,f,k),this._applyChange(j)}},j.prototype._processAckMessage=function(a){var b=a.data[0];b===g.ACTIONS.SUBSCRIBE?clearTimeout(this._readAckTimeout):b===g.ACTIONS.DELETE?(this.emit("delete"),this._destroy()):b===g.ACTIONS.UNSUBSCRIBE&&(this.emit("discard"),this._destroy())},j.prototype._applyUpdate=function(a){var b,c=parseInt(a.data[1],10);if(b=a.action===g.ACTIONS.PATCH?i.convertTyped(a.data[3],this._client):JSON.parse(a.data[2]),null===this.version)this.version=c;else if(this.version+1!==c)return void(a.action===g.ACTIONS.PATCH?this._connection.sendMsg(g.TOPIC.RECORD,g.ACTIONS.SNAPSHOT,[this.name]):this._recoverRecord(c,b,a));this.version=c,this._applyChange(d.set(this._$data,a.action===g.ACTIONS.PATCH?a.data[2]:void 0,b))},j.prototype._onRead=function(a){this.version=parseInt(a.data[1],10),this._applyChange(d.set(this._$data,void 0,JSON.parse(a.data[2]))),this._setReady()},j.prototype._setReady=function(){this.isReady=!0;for(var a=0;a<this._queuedMethodCalls.length;a++)this[this._queuedMethodCalls[a].method].apply(this,this._queuedMethodCalls[a].args);this._queuedMethodCalls=[],this.emit("ready")},j.prototype._setUpCallback=function(a,b){var c=Number(this.version)+1;this._writeCallbacks[c]=b},j.prototype._sendRead=function(){this._connection.sendMsg(g.TOPIC.RECORD,g.ACTIONS.CREATEORREAD,[this.name])},j.prototype._applyChange=function(a){if(!this.isDestroyed){var b=this._$data;if(this._$data=a,this._eventEmitter._callbacks)for(var c=Object.keys(this._eventEmitter._callbacks),e=0;e<c.length;e++){var f=d.get(a,c[e],!1),g=d.get(b,c[e],!1);f!==g&&this._eventEmitter.emit(c[e],this.get(c[e]))}}},j.prototype._normalizeArguments=function(a){if(1===a.length&&"object"==typeof a[0])return a[0];for(var b=Object.create(null),c=0;c<a.length;c++)"string"==typeof a[c]?b.path=a[c]:"function"==typeof a[c]?b.callback=a[c]:"boolean"==typeof a[c]&&(b.triggerNow=a[c]);return b},j.prototype._clearTimeouts=function(){clearTimeout(this._readAckTimeout),clearTimeout(this._deleteAckTimeout),clearTimeout(this._discardTimeout),clearTimeout(this._deleteAckTimeout)},j.prototype._checkDestroyed=function(a){return!!this.isDestroyed&&(this.emit("error","Can't invoke '"+a+"'. Record '"+this.name+"' is already destroyed"),!0)},j.prototype._onTimeout=function(a){this._clearTimeouts(),this.emit("error",a)},j.prototype._destroy=function(){this._clearTimeouts(),this._eventEmitter.off(),this._resubscribeNotifier.destroy(),this.isDestroyed=!0,this.isReady=!1,this._client=null,this._eventEmitter=null,this._connection=null},b.exports=j},{"../constants/constants":11,"../message/message-builder":16,"../message/message-parser":17,"../utils/resubscribe-notifier":29,"../utils/utils":31,"./json-path":20,"component-emitter":2}],24:[function(a,b,c){var d=a("../constants/constants"),e=a("../utils/ack-timeout-registry"),f=a("../utils/resubscribe-notifier"),g=a("./rpc-response"),h=a("./rpc"),i=a("../message/message-parser"),j=a("../message/message-builder"),k=function(a,b,c){this._options=a,this._connection=b,this._client=c,this._rpcs={},this._providers={},this._provideAckTimeouts={},this._ackTimeoutRegistry=new e(c,d.TOPIC.RPC,this._options.subscriptionTimeout),this._resubscribeNotifier=new f(this._client,this._reprovide.bind(this))};k.prototype.provide=function(a,b){if("string"!=typeof a||0===a.length)throw new Error("invalid argument name");if(this._providers[a])throw new Error("RPC "+a+" already registered");if("function"!=typeof b)throw new Error("invalid argument callback");this._ackTimeoutRegistry.add(a,d.ACTIONS.SUBSCRIBE),this._providers[a]=b,this._connection.sendMsg(d.TOPIC.RPC,d.ACTIONS.SUBSCRIBE,[a])},k.prototype.unprovide=function(a){if("string"!=typeof a||0===a.length)throw new Error("invalid argument name");this._providers[a]&&(delete this._providers[a],this._ackTimeoutRegistry.add(a,d.ACTIONS.UNSUBSCRIBE),this._connection.sendMsg(d.TOPIC.RPC,d.ACTIONS.UNSUBSCRIBE,[a]))},k.prototype.make=function(a,b,c){if("string"!=typeof a||0===a.length)throw new Error("invalid argument name");if("function"!=typeof c)throw new Error("invalid argument callback");var e=this._client.getUid(),f=j.typed(b);this._rpcs[e]=new h(this._options,c,this._client),this._connection.sendMsg(d.TOPIC.RPC,d.ACTIONS.REQUEST,[a,e,f])},k.prototype._getRpc=function(a,b,c){var e=this._rpcs[a];return e?e:(this._client._$onError(d.TOPIC.RPC,d.EVENT.UNSOLICITED_MESSAGE,c),null)},k.prototype._respondToRpc=function(a){var b,c=a.data[0],e=a.data[1],f=null;a.data[2]&&(f=i.convertTyped(a.data[2],this._client)),this._providers[c]?(b=new g(this._connection,c,e),this._providers[c](f,b)):this._connection.sendMsg(d.TOPIC.RPC,d.ACTIONS.REJECTION,[c,e])},k.prototype._$handle=function(a){var b,c,e;if(a.action===d.ACTIONS.REQUEST)return void this._respondToRpc(a);if(a.action===d.ACTIONS.ACK&&(a.data[0]===d.ACTIONS.SUBSCRIBE||a.data[0]===d.ACTIONS.UNSUBSCRIBE))return void this._ackTimeoutRegistry.clear(a);if(a.action===d.ACTIONS.ERROR){if(a.data[0]===d.EVENT.MESSAGE_PERMISSION_ERROR)return;if(a.data[0]===d.EVENT.MESSAGE_DENIED&&a.data[2]===d.ACTIONS.SUBSCRIBE)return void this._ackTimeoutRegistry.remove(a.data[1],d.ACTIONS.SUBSCRIBE)}a.action===d.ACTIONS.ERROR||a.action===d.ACTIONS.ACK?(c=a.data[0]===d.EVENT.MESSAGE_DENIED&&a.data[2]===d.ACTIONS.REQUEST?a.data[3]:a.data[2],b=a.data[1]):(b=a.data[0],c=a.data[1]),e=this._getRpc(c,b,a.raw),null!==e&&(a.action===d.ACTIONS.ACK?e.ack():a.action===d.ACTIONS.RESPONSE?(e.respond(a.data[2]),delete this._rpcs[c]):a.action===d.ACTIONS.ERROR&&(a.processedError=!0,e.error(a.data[0]),delete this._rpcs[c]))},k.prototype._reprovide=function(){for(var a in this._providers)this._connection.sendMsg(d.TOPIC.RPC,d.ACTIONS.SUBSCRIBE,[a])},b.exports=k},{"../constants/constants":11,"../message/message-builder":16,"../message/message-parser":17,"../utils/ack-timeout-registry":27,"../utils/resubscribe-notifier":29,"./rpc":26,"./rpc-response":25}],25:[function(a,b,c){var d=a("../constants/constants"),e=a("../utils/utils"),f=a("../message/message-builder"),g=function(a,b,c){this._connection=a,this._name=b,this._correlationId=c,this._isAcknowledged=!1,this._isComplete=!1,this.autoAck=!0,e.nextTick(this._performAutoAck.bind(this))};g.prototype.ack=function(){this._isAcknowledged===!1&&(this._connection.sendMsg(d.TOPIC.RPC,d.ACTIONS.ACK,[d.ACTIONS.REQUEST,this._name,this._correlationId]),this._isAcknowledged=!0)},g.prototype.reject=function(){this.autoAck=!1,this._isComplete=!0,this._isAcknowledged=!0,this._connection.sendMsg(d.TOPIC.RPC,d.ACTIONS.REJECTION,[this._name,this._correlationId])},g.prototype.error=function(a){this.autoAck=!1,this._isComplete=!0,this._isAcknowledged=!0,this._connection.sendMsg(d.TOPIC.RPC,d.ACTIONS.ERROR,[a,this._name,this._correlationId])},g.prototype.send=function(a){if(this._isComplete===!0)throw new Error("Rpc "+this._name+" already completed");this.ack();var b=f.typed(a);this._connection.sendMsg(d.TOPIC.RPC,d.ACTIONS.RESPONSE,[this._name,this._correlationId,b]),this._isComplete=!0},g.prototype._performAutoAck=function(){this.autoAck===!0&&this.ack()},b.exports=g},{"../constants/constants":11,"../message/message-builder":16,"../utils/utils":31}],26:[function(a,b,c){var d=a("../constants/constants"),e=a("../message/message-parser"),f=function(a,b,c){this._options=a,this._callback=b,this._client=c,this._ackTimeout=setTimeout(this.error.bind(this,d.EVENT.ACK_TIMEOUT),this._options.rpcAckTimeout),this._responseTimeout=setTimeout(this.error.bind(this,d.EVENT.RESPONSE_TIMEOUT),this._options.rpcResponseTimeout)};f.prototype.ack=function(){clearTimeout(this._ackTimeout)},f.prototype.respond=function(a){var b=e.convertTyped(a,this._client);this._callback(null,b),this._complete()},f.prototype.error=function(a){this._callback(a),this._complete()},f.prototype._complete=function(){clearTimeout(this._ackTimeout),clearTimeout(this._responseTimeout)},b.exports=f},{"../constants/constants":11,"../message/message-parser":17}],27:[function(a,b,c){var d=a("../constants/constants"),e=a("component-emitter"),f=function(a,b,c){this._client=a,this._topic=b,this._timeoutDuration=c,this._register={}};e(f.prototype),f.prototype.add=function(a,b){var c=b?b+a:a;this.remove(a,b),this._register[c]=setTimeout(this._onTimeout.bind(this,c,a),this._timeoutDuration)},f.prototype.remove=function(a,b){var c=b?b+a:a;this._register[c]&&this.clear({data:[b,a]})},f.prototype.clear=function(a){var b=a.data[1],c=a.data[0]+b,e=this._register[c]||this._register[b];e?clearTimeout(e):this._client._$onError(this._topic,d.EVENT.UNSOLICITED_MESSAGE,a.raw)},f.prototype._onTimeout=function(a,b){delete this._register[a];var c="No ACK message received in time for "+b;this._client._$onError(this._topic,d.EVENT.ACK_TIMEOUT,c),this.emit("timeout",b)},b.exports=f},{"../constants/constants":11,"component-emitter":2
}],28:[function(a,b,c){var d=a("../constants/constants"),e=a("./resubscribe-notifier"),f=function(a,b,c,d,f,g){this._type=a,this._callback=c,this._pattern=b,this._options=d,this._client=f,this._connection=g,this._ackTimeout=setTimeout(this._onAckTimeout.bind(this),this._options.subscriptionTimeout),this._resubscribeNotifier=new e(f,this._sendListen.bind(this)),this._sendListen(),this.destroyPending=!1};f.prototype.sendDestroy=function(){this.destroyPending=!0,this._connection.sendMsg(this._type,d.ACTIONS.UNLISTEN,[this._pattern]),this._resubscribeNotifier.destroy()},f.prototype.destroy=function(){this._callback=null,this._pattern=null,this._client=null,this._connection=null},f.prototype.accept=function(a){this._connection.sendMsg(this._type,d.ACTIONS.LISTEN_ACCEPT,[this._pattern,a])},f.prototype.reject=function(a){this._connection.sendMsg(this._type,d.ACTIONS.LISTEN_REJECT,[this._pattern,a])},f.prototype._createCallbackResponse=function(a){return{accept:this.accept.bind(this,a.data[1]),reject:this.reject.bind(this,a.data[1])}},f.prototype._$onMessage=function(a){a.action===d.ACTIONS.ACK?clearTimeout(this._ackTimeout):a.action===d.ACTIONS.SUBSCRIPTION_FOR_PATTERN_FOUND?this._callback(a.data[1],!0,this._createCallbackResponse(a)):a.action===d.ACTIONS.SUBSCRIPTION_FOR_PATTERN_REMOVED?this._callback(a.data[1],!1):this._client._$onError(this._type,d.EVENT.UNSOLICITED_MESSAGE,a.data[0]+"|"+a.data[1])},f.prototype._sendListen=function(){this._connection.sendMsg(this._type,d.ACTIONS.LISTEN,[this._pattern])},f.prototype._onAckTimeout=function(){this._client._$onError(this._type,d.EVENT.ACK_TIMEOUT,"No ACK message received in time for "+this._pattern)},b.exports=f},{"../constants/constants":11,"./resubscribe-notifier":29}],29:[function(a,b,c){var d=a("../constants/constants"),e=function(a,b){this._client=a,this._resubscribe=b,this._isReconnecting=!1,this._connectionStateChangeHandler=this._handleConnectionStateChanges.bind(this),this._client.on("connectionStateChanged",this._connectionStateChangeHandler)};e.prototype.destroy=function(){this._client.removeListener("connectionStateChanged",this._connectionStateChangeHandler),this._connectionStateChangeHandler=null,this._client=null},e.prototype._handleConnectionStateChanges=function(){var a=this._client.getConnectionState();a===d.CONNECTION_STATE.RECONNECTING&&this._isReconnecting===!1&&(this._isReconnecting=!0),a===d.CONNECTION_STATE.OPEN&&this._isReconnecting===!0&&(this._isReconnecting=!1,this._resubscribe())},b.exports=e},{"../constants/constants":11}],30:[function(a,b,c){var d=a("../constants/constants"),e=a("./resubscribe-notifier"),f=function(a,b,c,d,f){this._client=a,this._connection=b,this._topic=c,this._action=d,this._timeoutDuration=f,this._requests={},this._resubscribeNotifier=new e(this._client,this._resendRequests.bind(this))};f.prototype.hasRequest=function(a){return!!this._requests[a]},f.prototype.request=function(a,b){var c;this._requests[a]||(this._requests[a]=[],this._connection.sendMsg(this._topic,this._action,[a])),c=setTimeout(this._onResponseTimeout.bind(this,a),this._timeoutDuration),this._requests[a].push({timeout:c,callback:b})},f.prototype.recieve=function(a,b,c){var e=this._requests[a];if(!e)return void this._client._$onError(this._topic,d.EVENT.UNSOLICITED_MESSAGE,"no entry for "+a);for(i=0;i<e.length;i++)entry=e[i],clearTimeout(entry.timeout),entry.callback(b,c);delete this._requests[a]},f.prototype._onResponseTimeout=function(a){var b="No response received in time for "+this._topic+"|"+this._action+"|"+a;this._client._$onError(this._topic,d.EVENT.RESPONSE_TIMEOUT,b)},f.prototype._resendRequests=function(){for(var a in this._requests)this._connection.sendMsg(this._topic,this._action,[this._requests[a]])},b.exports=f},{"../constants/constants":11,"./resubscribe-notifier":29}],31:[function(a,b,c){(function(b){var d=/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,e="object";c.isNode="undefined"!=typeof b&&"[object process]"===b.toString(),c.nextTick=function(a){c.isNode?b.nextTick(a):setTimeout(a,0)},c.trim=function(a){return a.trim?a.trim():a.replace(d,"")},c.deepEquals=function(a,b){return a===b||typeof a===e&&typeof b===e&&JSON.stringify(a)===JSON.stringify(b)},c.deepCopy=function(a){return typeof a===e?JSON.parse(JSON.stringify(a)):a},c.shallowCopy=function(a){if(Array.isArray(a))return a.slice(0);if(typeof a===e){for(var b=Object.create(null),c=Object.keys(a),d=0;d<c.length;d++)b[c[d]]=a[c[d]];return b}return a},c.setTimeout=function(a,b){return null!==b?setTimeout(a,b):-1},c.setInterval=function(a,b){return null!==b?setInterval(a,b):-1};var f=/^wss:|^ws:|^\/\//,g=/^http:|^https:/,h=a("url");c.parseUrl=function(a,b){if(g.test(a))throw new Error("Only ws and wss are supported");f.test(a)?0===a.indexOf("//")&&(a="ws:"+a):a="ws://"+a;var c=h.parse(a);if(!c.host)throw new Error("invalid url, missing host");return c.protocol=c.protocol?c.protocol:"ws:",c.pathname=c.pathname?c.pathname:b,h.format(c)}}).call(this,a("_process"))},{_process:3,url:8}]},{},[10])(10)});